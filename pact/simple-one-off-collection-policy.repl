(begin-tx)
(env-exec-config ['DisablePact44] )
(env-data
  { 'ns-admin-keyset: []
  , 'ns-genesis-keyset:[]
  , 'ns-operate-keyset:[] })
(load "root/fungible-v2.pact")
(load "root/gas-payer-v1.pact")
(load "root/coin.pact")
(load "root/ns.pact")
(define-namespace 'kip (sig-keyset) (sig-keyset))

(load "kip/account-protocols-v1.pact")
(load "kip/manifest.pact")
(load "kip/token-policy-v1.pact")
(load "kip/poly-fungible-v2.pact")

(define-namespace 'util (sig-keyset) (sig-keyset))
(load "util/fungible-util.pact")
(commit-tx)

(begin-tx)
(env-data
 { 'marmalade-admin: ["marmalade-admin"]
 , 'marmalade-ns-user: ["marmalade-admin"]
 , 'marmalade-ns-admin: ["marmalade-admin"]
 , 'ns: "marmalade"
 , 'upgrade: false })
 (env-sigs [
   { 'key: 'marmalade-admin
    ,'caps: []
    }])

(load "ns-marmalade.pact")

(commit-tx)

(begin-tx)
(env-exec-config [] )
(load "ledger.pact")
(load "simple-one-off-collection-policy.pact")
(typecheck "marmalade.ledger" true)
(commit-tx)


(begin-tx "init collection")

(use marmalade.ledger)

(use kip.token-manifest)
(use marmalade.simple-1-off-whitelist-collection-policy)

(env-data {
    "k:cf8b92528f94af3e61ccf0dc403e1d4a1a86d7f5320d84c9b54f0c34d959b2bd": ["cf8b92528f94af3e61ccf0dc403e1d4a1a86d7f5320d84c9b54f0c34d959b2bd"]
  , "k:3ac1d889c1ff1a060aa1d69fd85e87f739ceae986fa1dd75fdd3246f349ebb6c": ["3ac1d889c1ff1a060aa1d69fd85e87f739ceae986fa1dd75fdd3246f349ebb6c"]
  , "k:d92c13eeb853c2e42918c077f006070934c27d9c03d4ec26bfbf1b4cb6261ef4": ["d92c13eeb853c2e42918c077f006070934c27d9c03d4ec26bfbf1b4cb6261ef4"]
  , "k:bea201d32e765e17195b9f48283c9844d887b5da9698310efc379309efac3380": ["bea201d32e765e17195b9f48283c9844d887b5da9698310efc379309efac3380"]
  , "k:ff523bb064601c0c52b7ebdfd1ed8a4772e44fd926c3425702cb4d12811bb8f9": ["ff523bb064601c0c52b7ebdfd1ed8a4772e44fd926c3425702cb4d12811bb8f9"]
  , 'operator: ['operator]
  })

(expect  "initiates collection-0 bid"
  true
  (let*
    ( (stringify-index (lambda (index:integer) (format "{}" [index])))
      (get-manifest (lambda (index:integer)
        (create-manifest (uri "text" (stringify-index index)) [])
        ))
      (manifests:list (map get-manifest (enumerate 0 4)))
      (hashes:list (map (at 'hash ) manifests))
      (tokens:list (map (token-id) hashes))
      (tokens-hash:string (hash tokens)))
      (init-collection "collection-0" 5 tokens-hash coin 5.0 "operator" (read-keyset 'operator))
      )
  )

(expect "INIT_COLLECTION events"
  [{ "name": "marmalade.simple-1-off-whitelist-collection-policy.INIT_COLLECTION"
    ,"params": ["collection-0" 5 coin 5.0 "operator"]}]
  (map (remove 'module-hash )(env-events true))
)

(test-capability (coin.COINBASE))
(expect "fund buyers"
   ["Write succeeded" "Write succeeded" "Write succeeded" "Write succeeded" "Write succeeded"]
  (let*
    (
     (buyers  [
        "k:cf8b92528f94af3e61ccf0dc403e1d4a1a86d7f5320d84c9b54f0c34d959b2bd"
        "k:3ac1d889c1ff1a060aa1d69fd85e87f739ceae986fa1dd75fdd3246f349ebb6c"
        "k:d92c13eeb853c2e42918c077f006070934c27d9c03d4ec26bfbf1b4cb6261ef4"
        "k:bea201d32e765e17195b9f48283c9844d887b5da9698310efc379309efac3380"
        "k:ff523bb064601c0c52b7ebdfd1ed8a4772e44fd926c3425702cb4d12811bb8f9"])
     (fund (lambda (account:string) (coin.coinbase account (read-keyset account ) 5.0) ))
     )
     (map fund buyers))
)

(expect "COINBASE events"
  [ {"name": "coin.TRANSFER","params": ["" "k:cf8b92528f94af3e61ccf0dc403e1d4a1a86d7f5320d84c9b54f0c34d959b2bd" 5.0]}
    {"name": "coin.TRANSFER","params": ["" "k:3ac1d889c1ff1a060aa1d69fd85e87f739ceae986fa1dd75fdd3246f349ebb6c" 5.0]}
    {"name": "coin.TRANSFER","params": ["" "k:d92c13eeb853c2e42918c077f006070934c27d9c03d4ec26bfbf1b4cb6261ef4" 5.0]}
    {"name": "coin.TRANSFER","params": ["" "k:bea201d32e765e17195b9f48283c9844d887b5da9698310efc379309efac3380" 5.0]}
    {"name": "coin.TRANSFER","params": ["" "k:ff523bb064601c0c52b7ebdfd1ed8a4772e44fd926c3425702cb4d12811bb8f9" 5.0]}]
  (map (remove 'module-hash )(env-events true))
)

(expect "create operator account"
   "Write succeeded"
   (coin.create-account 'operator (read-keyset 'operator))
)

(env-sigs
   [{ 'key: "cf8b92528f94af3e61ccf0dc403e1d4a1a86d7f5320d84c9b54f0c34d959b2bd" ,'caps: [(coin.TRANSFER "k:cf8b92528f94af3e61ccf0dc403e1d4a1a86d7f5320d84c9b54f0c34d959b2bd" "operator" 5.0)] }
    { 'key: "3ac1d889c1ff1a060aa1d69fd85e87f739ceae986fa1dd75fdd3246f349ebb6c" ,'caps: [(coin.TRANSFER "k:3ac1d889c1ff1a060aa1d69fd85e87f739ceae986fa1dd75fdd3246f349ebb6c" "operator" 5.0)] }
    { 'key: "d92c13eeb853c2e42918c077f006070934c27d9c03d4ec26bfbf1b4cb6261ef4" ,'caps: [(coin.TRANSFER "k:d92c13eeb853c2e42918c077f006070934c27d9c03d4ec26bfbf1b4cb6261ef4" "operator" 5.0)] }
    { 'key: "bea201d32e765e17195b9f48283c9844d887b5da9698310efc379309efac3380" ,'caps: [(coin.TRANSFER "k:bea201d32e765e17195b9f48283c9844d887b5da9698310efc379309efac3380" "operator" 5.0)] }
])

(expect  "4 buyers buy whitelist from collection-0"
  [true true true true]
  (let*
    ((buyers  [
       "k:cf8b92528f94af3e61ccf0dc403e1d4a1a86d7f5320d84c9b54f0c34d959b2bd"
       "k:3ac1d889c1ff1a060aa1d69fd85e87f739ceae986fa1dd75fdd3246f349ebb6c"
       "k:d92c13eeb853c2e42918c077f006070934c27d9c03d4ec26bfbf1b4cb6261ef4"
       "k:bea201d32e765e17195b9f48283c9844d887b5da9698310efc379309efac3380"]))
   (map (reserve-whitelist "collection-0") buyers)
  )
  )

(expect "RESERVE_SALE events"
  [ {"name": "coin.TRANSFER","params": ["k:cf8b92528f94af3e61ccf0dc403e1d4a1a86d7f5320d84c9b54f0c34d959b2bd" "operator" 5.0]}
    {"name": "marmalade.simple-1-off-whitelist-collection-policy.RESERVE_SALE","params": ["collection-0" "k:cf8b92528f94af3e61ccf0dc403e1d4a1a86d7f5320d84c9b54f0c34d959b2bd" 0]}
    {"name": "coin.TRANSFER","params": ["k:3ac1d889c1ff1a060aa1d69fd85e87f739ceae986fa1dd75fdd3246f349ebb6c" "operator" 5.0]}
    {"name": "marmalade.simple-1-off-whitelist-collection-policy.RESERVE_SALE","params": ["collection-0" "k:3ac1d889c1ff1a060aa1d69fd85e87f739ceae986fa1dd75fdd3246f349ebb6c" 1]}
    {"name": "coin.TRANSFER","params": ["k:d92c13eeb853c2e42918c077f006070934c27d9c03d4ec26bfbf1b4cb6261ef4" "operator" 5.0]}
    {"name": "marmalade.simple-1-off-whitelist-collection-policy.RESERVE_SALE","params": ["collection-0" "k:d92c13eeb853c2e42918c077f006070934c27d9c03d4ec26bfbf1b4cb6261ef4" 2]}
    {"name": "coin.TRANSFER","params": ["k:bea201d32e765e17195b9f48283c9844d887b5da9698310efc379309efac3380" "operator" 5.0]}
    {"name": "marmalade.simple-1-off-whitelist-collection-policy.RESERVE_SALE","params": ["collection-0" "k:bea201d32e765e17195b9f48283c9844d887b5da9698310efc379309efac3380" 3]}]
  (map (remove 'module-hash )(env-events true))
)

(env-sigs
   [{ 'key: "operator" ,'caps: [(marmalade.simple-1-off-whitelist-collection-policy.OPERATOR "collection-0")] }
])

(expect-failure "Clear the bid fails - whitelist is not fully sold"
  "bid is in the process"
  (let*
    ( (stringify-index (lambda (index:integer) (format "{}" [index])))
      (get-manifest (lambda (index:integer)
        (create-manifest (uri "text" (stringify-index index)) [])
        ))
      (manifests:list (map get-manifest (enumerate 0 4)))
      (hashes:list (map (at 'hash ) manifests))
      (tokens:list (map (token-id) hashes)) )
      (reveal-tokens "collection-0" tokens)
      ))

(env-sigs
   [{ 'key: "ff523bb064601c0c52b7ebdfd1ed8a4772e44fd926c3425702cb4d12811bb8f9" ,'caps: [(coin.TRANSFER "k:ff523bb064601c0c52b7ebdfd1ed8a4772e44fd926c3425702cb4d12811bb8f9" "operator" 5.0)] }
])

(env-chain-data
  {'block-height: 20987})

(expect "last whitelist slot is sold"
  true
  (reserve-whitelist "collection-0" "k:ff523bb064601c0c52b7ebdfd1ed8a4772e44fd926c3425702cb4d12811bb8f9"))

(expect "RESERVE_SALE events"
  [ {"name": "coin.TRANSFER","params": ["k:ff523bb064601c0c52b7ebdfd1ed8a4772e44fd926c3425702cb4d12811bb8f9" "operator" 5.0]}
    {"name": "marmalade.simple-1-off-whitelist-collection-policy.RESERVE_SALE","params": ["collection-0" "k:ff523bb064601c0c52b7ebdfd1ed8a4772e44fd926c3425702cb4d12811bb8f9" 4]} ]
  (map (remove 'module-hash )(env-events true))
)

(env-sigs
   [{ 'key: "operator" ,'caps: [(marmalade.simple-1-off-whitelist-collection-policy.OPERATOR "collection-0")] }
])

(expect "Clear the bid succeeds"
  true
  (let*
    ( (stringify-index (lambda (index:integer) (format "{}" [index])))
      (get-manifest (lambda (index:integer)
        (create-manifest (uri "text" (stringify-index index)) [])
        ))
      (manifests:list (map get-manifest (enumerate 0 4)))
      (hashes:list (map (at 'hash ) manifests))
      (tokens:list (map (token-id) hashes)) )
      (reveal-tokens "collection-0" tokens)
))

(expect "REVEAL_TOKEN events"
  [{"name": "marmalade.simple-1-off-whitelist-collection-policy.REVEAL_TOKENS",
    "params": ["collection-0"
                ["t:fgnk8jnlTvB8iToPf2ACNpy8BInAj5OTXvzELgAKvRc"
                 "t:A431JP6Z0MZ3b6-bYuD3PgNDjCLa_BwhUW1jvHu9tkQ"
                 "t:9mCeDcVIuQET1awDEWbYXF-HlRzhLv5VW3hXiW9m678"
                 "t:fqfxqkkMwG4FuyttGzosh_JpLOD-LUzt_D8K_5UhFg8"
                 "t:kTKLjmYoR9AOyv8KXcgNGOy8PGeF3cRwmYAofLdMa4w"]]}]
  (map (remove 'module-hash )(env-events true))
)

(commit-tx)

(begin-tx "create-token")
(use kip.token-manifest)
(use marmalade.ledger)
(use marmalade.simple-1-off-whitelist-collection-policy)

(env-data {
 'collection-id: "collection-0"
  })

(env-sigs [
  { 'key: 'operator
   ,'caps: [(OPERATOR "collection-0")]
  }])

(expect "create t:9mCeDcVIuQET1awDEWbYXF-HlRzhLv5VW3hXiW9m678"
  true
  (marmalade.ledger.create-token
    (token-id (at 'hash (create-manifest (uri "text" "2") [])))
    0
    (create-manifest (uri "text" "2") [])
    marmalade.simple-1-off-whitelist-collection-policy)
)

(expect "create t:A431JP6Z0MZ3b6-bYuD3PgNDjCLa_BwhUW1jvHu9tkQ"
  true
  (marmalade.ledger.create-token
    (token-id (at 'hash (create-manifest (uri "text" "1") [])))
    0
    (create-manifest (uri "text" "1") [])
    marmalade.simple-1-off-whitelist-collection-policy)
)

(expect-failure "create token with invalid manifest hash fails"
  "Invalid token-id"
  (marmalade.ledger.create-token
    "t:9mCeDcVIuQET1awDEWbYXF-HlRzhLv5VW3hXiW9m678"
    0
    (create-manifest (uri "text" "3") [])
    marmalade.simple-1-off-whitelist-collection-policy)
)

(commit-tx)

(begin-tx "mint-token")
(use kip.token-manifest)
(use marmalade.ledger)
(use marmalade.simple-1-off-whitelist-collection-policy)

(env-data {
    "ks": ['cf8b92528f94af3e61ccf0dc403e1d4a1a86d7f5320d84c9b54f0c34d959b2bd ]
   ,'buyer-index : 2
})

(env-sigs [
  { 'key: 'operator
   ,'caps: [(marmalade.ledger.MINT "t:9mCeDcVIuQET1awDEWbYXF-HlRzhLv5VW3hXiW9m678" "k:cf8b92528f94af3e61ccf0dc403e1d4a1a86d7f5320d84c9b54f0c34d959b2bd" 1.0)]
    }])
(env-chain-data
  {'block-height: 20987})

(expect-failure "Mint fails for buyer at index 0 to mint with wrong buyer index"
  "Wrong buyer index"
  (marmalade.ledger.mint
    "t:9mCeDcVIuQET1awDEWbYXF-HlRzhLv5VW3hXiW9m678"
    "k:cf8b92528f94af3e61ccf0dc403e1d4a1a86d7f5320d84c9b54f0c34d959b2bd"
    (read-keyset "ks")
    1.0))

  (env-data {
      "ks": ['cf8b92528f94af3e61ccf0dc403e1d4a1a86d7f5320d84c9b54f0c34d959b2bd ]
     ,'buyer-index : 0
  })

  (expect "Mint succeeds for buyer at index 0 to mint token at index 2"
  true
  (marmalade.ledger.mint
    "t:9mCeDcVIuQET1awDEWbYXF-HlRzhLv5VW3hXiW9m678"
    "k:cf8b92528f94af3e61ccf0dc403e1d4a1a86d7f5320d84c9b54f0c34d959b2bd"
    (read-keyset "ks")
    1.0))

(env-data {
    'ks: ['d92c13eeb853c2e42918c077f006070934c27d9c03d4ec26bfbf1b4cb6261ef4 ]
   ,'buyer-index : 2
})

(env-sigs [
  { 'key: 'operator
   ,'caps: [(marmalade.ledger.MINT "t:A431JP6Z0MZ3b6-bYuD3PgNDjCLa_BwhUW1jvHu9tkQ" "k:d92c13eeb853c2e42918c077f006070934c27d9c03d4ec26bfbf1b4cb6261ef4" 1.0)]
    }])

(expect-failure "mint token with non-whitelisted account"
  "Account is not whitelisted for the token"
  (marmalade.ledger.mint
    "t:A431JP6Z0MZ3b6-bYuD3PgNDjCLa_BwhUW1jvHu9tkQ"
    "k:d92c13eeb853c2e42918c077f006070934c27d9c03d4ec26bfbf1b4cb6261ef4"
    (read-keyset 'ks)
    1.0)
)


(rollback-tx)



;; Principal

;; revealing token-id (before create-token) can allow people to reserve that token id using a different policy.
